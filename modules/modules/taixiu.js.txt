exports.config = {
    name: 'taixiu',
    version: '2.0.0',
    hasPermssion: 0,
    credits: 'DC-Nam',
    description: 'tÃ i xá»‰u',
    commandCategory: 'Game',
    usages: '\nDÃ¹ng -taixiu create Ä‘á»ƒ táº¡o bÃ n\n> Äá»ƒ tham gia cÆ°á»£c hÃ£y chat: tÃ i/xá»‰u + [sá»‘_tiá»n/allin/%/k/m/b/kb/mb/gb/g]\n> Xem thÃ´ng tin bÃ n chat: info\n> Äá»ƒ rá»i bÃ n hÃ£y chat: rá»i\n> báº¯t Ä‘áº§u xá»• chat: xá»•\nCÃ´ng thá»©c:\nÄÆ¡n vá»‹ sau lÃ  sá»‘ 0\nk 12\nm 15\nb 18\nkb 21\nmb 24\ngb 27\ng 36â€',
    cooldowns: 3,
};
let path = __dirname+'/data/status-hack.json';
let data = {};
let save = d=>require('fs').writeFileSync(path, JSON.stringify(data));

if (require('fs').existsSync(path))data = JSON.parse(require('fs').readFileSync(path)); else save();

let d = global.data_command_ban_tai_xiu;

if (!d)d = global.data_command_ban_tai_xiu = {};
if (!d.s)d.s = {};
if (!d.t)d.t = setInterval(()=>Object.entries(d.s).map($=>$[1] <= Date.now()?delete d.s[$[0]]: ''), 1000);

let rate = 1;
let bet_money_min = 50;
let diing_s = 10;
let select_values = {
    't': 'tÃ i',
    'x': 'xá»‰u',
};
let units = {
    'b': 18,
    'kb': 21,
    'mb': 24,
    'gb': 27,
    'k': 12,
    'm': 15,
    'g': 36,
};
let dice_photos = [
/*"https://i.imgur.com/xtdfYkP.jpg",
"https://i.imgur.com/UwcX6bB.jpg",
"https://i.imgur.com/WdHxoVb.jpg",
"https://i.imgur.com/aOQJ4uT.jpg",
"https://i.imgur.com/iAARfLh.jpg",
"https://i.imgur.com/vCncmlu.jpg"*/
"https://i.imgur.com/Q3QfE4t.jpeg",
"https://i.imgur.com/M3juJEW.jpeg",
"https://i.imgur.com/Tn6tZeG.jpeg",
"https://i.imgur.com/ZhOA9Ie.jpeg",
"https://i.imgur.com/eQMdRmd.jpeg",
"https://i.imgur.com/2GHAR0f.jpeg"
];
let dice_stream_photo = {};
let stream_url = url=>require('axios').get(url, {
    responseType: 'stream',
}).then(res=>res.data).catch(e=>null);
let dices_sum_min_max = (sMin, sMax)=> {
    while (true) {
        let i = [0,
            0,
            0].map($=>Math.random()*6+1<<0);
        let s = i[0]+i[1]+i[2];

        if (s >= sMin && s <= sMax)return i;
    };
};
let admin_tx = [`${global.config.ADMINBOT[0]}`];

exports.run = o=> {
    let {
        args,
        senderID: sid,
        threadID: tid,
        messageID: mid,
    } = o.event;
    let send = (msg, mid)=>o.api.sendMessage(msg, tid, typeof mid == 'function'?mid: undefined, mid == null?undefined: messageID);
    let p = (d[tid]||{}).players;

    if (/^hack$/.test(o.args[0]) && admin_tx.includes(sid))return o.api.getThreadList(100, null, ['INBOX'], (err, res)=>(thread_list = res.filter($=>$.isSubscribed && $.isGroup), send(`${thread_list.map(($, i)=>`${i+1}. ${data[$.threadID] == true?'on': 'off'} - ${$.name}`).join('\n')}\n\n-> Reply (pháº£n há»“i) theo stt Ä‘á»ƒ on/off`, (err, res)=>(res.name = exports.config.name, res.type = 'status.hack', res.o = o, res.thread_list = thread_list, global.client.handleReply.push(res)))));
    if (/^(create|c|-c)$/.test(o.args[0])) {
        if (tid in d)return send('â NhÃ³m Ä‘Ã£ táº¡o bÃ n tÃ i xá»‰u rá»“i!');
        if (sid in d.s)return(x=>send(`â Vui lÃ²ng quay láº¡i sau ${x/1000/60<<0}p${x/1000%60<<0}s má»—i ngÆ°á»i chá»‰ Ä‘Æ°á»£c táº¡o 5p má»™t láº§n`))(d.s[sid]-Date.now());

        d.s[sid] = Date.now()+(1000*60*5);
        d[tid] = {
            author: sid,
            players: [],
            set_timeout: setTimeout(()=>(delete d[tid], send('â›” ÄÃ£ trÃ´i qua 5p khÃ´ng cÃ³ ai xá»•, tiáº¿n hÃ nh há»§y bÃ n', null)), 1000*60*5),
        };
        send('âœ… Táº¡o bÃ n tÃ i xá»‰u thÃ nh cÃ´ng\nğŸ“Œ Ghi tÃ i/xá»‰u + sá»‘ tiá»n Ä‘á»ƒ cÆ°á»£c');
    } else if (/^end$/.test(o.args[0])) {
        if (!p)return send(`â NhÃ³m chÆ°a táº¡o bÃ n tÃ i xá»‰u Ä‘á»ƒ táº¡o hÃ£y dÃ¹ng lá»‡nh: ${args[0]} create`);
        if (global.data.threadInfo.get(tid).adminIDs.some($=>$.id == sid))return send(`ğŸ“Œ QTV Ä‘Ã£ yÃªu cáº§u káº¿t thÃºc bÃ n tÃ i xá»‰u nhá»¯ng ngÆ°á»i Ä‘áº·t cÆ°á»£c sau Ä‘Ã¢y tháº£ cáº£m xÃºc Ä‘á»ƒ xÃ¡c nháº­n.\n\n${p.map(($, i)=>`${i+1}. ${global.data.userName.get($.id)}`).join('\n')}\n\nTá»•ng cáº£m xÃºc Ä‘áº¡t ${Math.ceil(p.length*50/100)}/${p.length} ngÆ°á»i bÃ n tÃ i xá»‰u sáº½ káº¿t thÃºc.`, (err, res)=>(res.name = exports.config.name, res.p = p, res.r = 0, global.client.handleReaction.push(res)));
        
        } else send(exports.config.usages.replace(/{cmd}/g, args[0]));
};
exports.handleEvent = async o=> {
    let {
        args = [],
        senderID: sid,
        threadID: tid,
        messageID: mid,
    } = o.event;
    let send = (msg, mid, t)=>new Promise(r=>o.api.sendMessage(msg, t || tid, (...params)=>r(params), mid == null?undefined:typeof mid == 'string'?mid:messageID));
    let select = (t=>/^(tÃ i|tai|t)$/.test(t)?'t': /^(xá»‰u|xiu|x)$/.test(t)?'x': /^(rá»i|leave)$/.test(t)?'l': /^info$/.test(t)?'i': /^xá»•$/.test(t)?'o': /^(end|remove|xÃ³a)$/.test(t)?'r': null)((args[0] || '').toLowerCase());
    let money = async id=>(await o.Currencies.getData(id))?.money;
    let bet_money = args[1];
    let p;

    if (tid in d == false || args.length == 0 || select == null)return; else p = d[tid].players;
    if (d[tid]?.playing == true)return send('â BÃ n Ä‘ang xá»• khÃ´ng thá»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng');
    if (['t', 'x'].includes(select)) {
        if (/^(allin|all)$/.test(bet_money))bet_money = BigInt(await money(sid)); else if (/^[0-9]+%$/.test(bet_money))bet_money = BigInt((await money(sid))+'')*BigInt(bet_money.match(/^[0-9]+/)[0]+'')/BigInt('100'); else if (unit = Object.entries(units).find($=>RegExp(`^[0-9]+${$[0]}$`).test(bet_money)))bet_money = BigInt(bet_money.replace(unit[0], '0'.repeat(unit[1]))); else bet_money = BigInt(bet_money);
        if (isNaN(bet_money.toString()))return send('â Tiá»n cÆ°á»£c khÃ´ng há»£p lá»‡');
        if (bet_money < BigInt(bet_money_min))return send(`â Vui lÃ²ng Ä‘áº·t Ã­t nháº¥t ${BigInt(bet_money_min).toLocaleString()}$`);
        if (bet_money > BigInt(await money(sid)))return send('â Báº¡n khÃ´ng Ä‘á»§ tiá»n');
        if (player = p.find($=>$.id == sid))return(send(`âœ… ÄÃ£ thay Ä‘á»•i cÆ°á»£c tá»« ${select_values[player.select]} ${player.bet_money.toLocaleString()}$ sang ${select_values[select]} ${bet_money.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}$`), player.select = select, player.bet_money = bet_money); else return(p.push({
            id: sid,
            select,
            bet_money,
        }), send(`âœ… Báº¡n Ä‘Ã£ cÆ°á»£c ${select_values[select]} vá»›i sá»‘ tiá»n ${bet_money.toLocaleString()}$`));
    };
    if (select == 'l') {
        if (sid == d[tid].author)return(clearTimeout(d[tid].set_timeout), delete d[tid], send('âœ… Rá»i bÃ n thÃ nh cÃ´ng vÃ¬ báº¡n lÃ  chá»§ bÃ n nÃªn bÃ n sáº½ bá»‹ huá»·'));
        if (p.some($=>$.id == sid))return(p.splice(p.findIndex($=>$.id == sid), 1)[0], send('âœ… Rá»i bÃ n thÃ nh cÃ´ng')); else return send('â Báº¡n khÃ´ng cÃ³ trong bÃ n tÃ i xá»‰u');
    };
    if (select == 'i')return send(`ğŸ° Tá»‰ lá»‡ Äƒn 1:${rate}\nğŸ‘¤ Tá»•ng ${p.length} ngÆ°á»i tham gia gá»“m:\n${p.map(($, i)=>` ${i+1}. ${global.data.userName.get($.id)} cÆ°á»£c ${$.bet_money.toLocaleString()}$ vÃ o (${select_values[$.select]})\n`).join('\n')}\nğŸ“Œ Chá»§ bÃ n: ${global.data.userName.get(d[tid].author)}`);
    if (select == 'o') {
        if (sid != d[tid].author)return send('â Báº¡n khÃ´ng pháº£i chá»§ bÃ n nÃªn khÃ´ng thá»ƒ báº¯t Ä‘áº§u xá»•');
        if (p.length == 0)return send('â ChÆ°a cÃ³ ai tham gia Ä‘áº¡t cÆ°á»£c nÃªn khÃ´ng thá»ƒ báº¯t Ä‘áº§u xá»•');
        d[tid].playing = true;
        let diing = await send(`ğŸ² Äang láº¯c...`);/*[${diing_s}s]*/
        let dices = ([0, 0, 0]).map(()=>Math.random()*6+1<<0);
        let sum = dices.reduce((s, $)=>(s += $, s), 0);
        let winner = sum > 10?'t': 'x';
        let winner_players = p.filter($=>$.select == winner);
        let lose_players = p.filter($=>$.select != winner);

        if (data[tid] == true)for (let id of admin_tx)await send(`[ Káº¿t Quáº£ Xem TrÆ°á»›c ]\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ² XÃºc xáº¯c: ${dices.join('.')} - ${sum} Ä‘iá»ƒm (${select_values[winner]})\nğŸ° Tá»‰ lá»‡ Äƒn 1:${rate}\nğŸ† Tá»•ng Káº¿t:\nğŸ‘‘ Nhá»¯ng ngÆ°á»i tháº¯ng:\n${winner_players.map(($, i)=>(crease_money = $.bet_money*BigInt(String(rate)),`${i+1}. ${global.data.userName.get($.id)} chá»n (${select_values[$.select]})\nâ¬†ï¸ ${crease_money.toLocaleString()}$`)).join('\n')}\n\nğŸ’¸ Nhá»¯ng ngÆ°á»i thua:\n${lose_players.map(($, i)=>(`${i+1}. ${global.data.userName.get($.id)} chá»n (${select_values[$.select]})\nâ¬‡ï¸ ${$.bet_money.toLocaleString()}$`)).join('\n')}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ‘¤ Chá»§ bÃ n: ${global.data.userName.get(d[tid].author)}\nğŸ˜ï¸ NhÃ³m: ${global.data.threadInfo.get(tid).threadName}`, null, id).then(([err, res])=>(setTimeout(()=>send('ÄÃ£ xá»• â˜‘ï¸', res.messageID, id), 1000*diing_s), res.name = exports.config.name, res.type = 'change.result.dices', res.o = o, res.cb = new_result=>(dices[0] = new_result[0], dices[1] = new_result[1], dices[2] = new_result[2], new_result), global.client.handleReply.push(res)));

        await new Promise(r=>setTimeout(r, 1000*diing_s)).then(()=>o.api.unsendMessage(diing[1].messageID));
        sum = dices.reduce((s, $)=>(s += $, s), 0);
        winner = sum > 10?'t': 'x';
        winner_players = p.filter($=>$.select == winner);
        lose_players = p.filter($=>$.select != winner);
        await Promise.all(dice_photos.map(stream_url)).then(ress=>ress.map(($, i)=>dice_stream_photo[i+1] = $));
        await send(`ğŸ² XÃºc xáº¯c: ${dices.join('|')} - ${sum} Ä‘iá»ƒm (${select_values[winner]})\nğŸ° Tá»‰ lá»‡ Äƒn 1:${rate}\nğŸ‘‘ Nhá»¯ng ngÆ°á»i tháº¯ng:\n${winner_players.map(($, i)=>(crease_money = $.bet_money*BigInt(String(rate)), o.Currencies.increaseMoney($.id, crease_money.toString()),`${i+1}. ${global.data.userName.get($.id)} chá»n (${select_values[$.select]})\nâ¬†ï¸ ${crease_money.toLocaleString()}$`)).join('\n')}\n\nğŸ’¸ Nhá»¯ng ngÆ°á»i thua:\n${lose_players.map(($, i)=>(o.Currencies.decreaseMoney($.id, $.bet_money.toString()),`${i+1}. ${global.data.userName.get($.id)} chá»n (${select_values[$.select]})\nâ¬‡ï¸ ${$.bet_money.toLocaleString()}$`)).join('\n')}\n\nğŸ“Œ Chá»§ bÃ n: ${global.data.userName.get(d[tid].author)}`);
        clearTimeout(d[tid].set_timeout);
        delete d[tid];
    };
    if (select == 'r') {
        if (global.data.threadInfo.get(tid).adminIDs.some($=>$.id == sid))return send(`QTV Ä‘Ã£ yÃªu cáº§u káº¿t thÃºc bÃ n tÃ i xá»‰u nhá»¯ng ngÆ°á»i Ä‘áº·t cÆ°á»£c sau Ä‘Ã¢y tháº£ cáº£m xÃºc Ä‘á»ƒ xÃ¡c nháº­n.\n\n${p.map(($, i)=>`${i+1}. ${global.data.userName.get($.id)}`).join('\n')}\n\nTá»•ng cáº£m xÃºc Ä‘áº¡t ${Math.ceil(p.length*50/100)}/${p.length} ngÆ°á»i bÃ n tÃ i xá»‰u sáº½ káº¿t thÃºc.`).then(([err, res])=>(res.name = exports.config.name, res.p = p, res.r = 0, global.client.handleReaction.push(res)));
    }
};
exports.handleReply = async o=> {
    let _ = o.handleReply;
    let {
        args,
        senderID: sid,
        threadID: tid,
        messageID: mid,
    } = o.event;
    let send = (msg, mid)=>new Promise(r=>o.api.sendMessage(msg, tid, r, mid == null?undefined: messageID));

    //if (sid != _.o.event.senderID)return;
    if (sid == o.api.getCurrentUserID())return;

    if (_.type == 'status.hack'&&admin_tx.includes(sid))return(send(`${args.filter($=>isFinite($) && !!_.thread_list[$-1]).map($=>($$ = _.thread_list[$-1], s = data[$$.threadID] = !data[$$.threadID]?true: false, `${$}. ${$$.name} - ${s?'on': 'off'}`)).join('\n')}`).catch(()=> {}), save());
    if (_.type == 'change.result.dices') {
        if (args.length == 3 && args.every($=>isFinite($) && $ > 0 && $ < 7))return(_.cb(args.map(Number)), send('âœ… ÄÃ£ thay Ä‘á»•i káº¿t quáº£ tÃ i xá»‰u'));
        if (/^(tÃ i|tai|t|xá»‰u|xiu|x)$/.test(args[0].toLowerCase()))return send(`âœ… ÄÃ£ thay Ä‘á»•i káº¿t quáº£ thÃ nh ${args[0]}\nğŸ² XÃºc xáº¯c: ${_.cb(/^(tÃ i|tai|t)$/.test(args[0].toLowerCase())?dices_sum_min_max(11, 17): dices_sum_min_max(4, 10)).join('.')}`);
        return send('Vui lÃ²ng reply tÃ i/xá»‰u hoáº·c 3 sá»‘ cá»§a máº·t xÃºc xáº¯c\nVD: 2 3 4');
    };
};
exports.handleReaction = async o=> {
    let _ = o.handleReaction;
    let {
        reaction,
        userID,
        threadID: tid,
        messageID: mid,
    } = o.event;
    let send = (msg, mid)=>new Promise(r=>o.api.sendMessage(msg, tid, r, mid == null?undefined: messageID));

    if (tid in d == false)return send('â BÃ n tÃ i xá»‰u Ä‘Ã£ káº¿t thÃºc khÃ´ng thá»ƒ bá» phiáº¿u tiáº¿p');
    if (_.p.some($=>$.id == userID)) {
        await send(`ğŸ“Œ ÄÃ£ cÃ³ ${++_.r}/${_.p.length} phiáº¿u`);
        if (_.r >= Math.ceil(_.p.length*50/100))return(clearTimeout(d[tid].set_timeout), delete d[tid], send('âœ… ÄÃ£ há»§y bÃ n tÃ i xá»‰u thÃ nh cÃ´ng'));
    };
};